<!-- templates/index.html -->
<!doctype html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <title>ESSOSC Viewer</title>
    <link rel='icon' type='image/png' href='static/favicon.ico'>

    <style>
      :root { color-scheme: dark; }
      html, body, #app { height: 100%; margin: 0; }
      #map { height: 100%; }
    </style>


    <style>
      /* preload base CSS while the rest lazy loads */
      :root { color-scheme: dark; }
      html,body,#app{height:100%;margin:0}
      #map{height:100%}
      #map.leh, .leaflet-container{background:#0f1115}
    </style>

    {# async-load the built CSS; keep noscript fallback #}
    {% for href in main_css_list %}
    <link rel="preload" href="{{ href }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ href }}"></noscript>
    {% endfor %}
  </head>
  <body>
    <header>
      <div class='brand'>
        ESSOSC Viewer
        <span id='appVersion' class='tool-description'>{{ app_version }}</span>
      </div>
      <div id='topbarContent' class='topbar-content'>
        <div class='controls-bar'>
          <div class='control-group layers'>
            {% for layer_id in ['A', 'B'] %}
            <div class='layer-group'>
              <label class='layer-label'>Select a layer to display ({{ layer_id }})</label>
              <div id="layerMeta{{ layer_id}}" class="layer-meta"></div>
              <select id='layerSelect{{ layer_id }}' data-default='{{ initial_layers.get(layer_id, "") }}'>
              </select>
              <label class='vis-label'>
                <input id='layerVisible{{ layer_id }}' type='checkbox' checked />
                <span>Show</span>
              </label>
            </div>
            {% endfor %}
          </div>
          <div class='control-group style'>
            {% for layer_id in ['A', 'B'] %}
            <details class='style-panel'>
              <summary>Style {{ layer_id }}</summary>
              <div class='style-grid'>
                <div class='style-row'>
                  <label>Min</label>
                  <input id='layer{{ layer_id }}MinInput' type='number' step='any' />
                  <input id='layer{{ layer_id }}CminInput' type='color' />
                </div>
                <div class='style-row'>
                  <label>Med</label>
                  <input id='layer{{ layer_id }}MedInput' type='number' step='any' />
                  <input id='layer{{ layer_id }}CmedInput' type='color' />
                </div>
                <div class='style-row'>
                  <label>Max</label>
                  <input id='layer{{ layer_id }}MaxInput' type='number' step='any' />
                  <input id='layer{{ layer_id }}CmaxInput' type='color' />
                </div>
              </div>
            </details>
            {% endfor %}
            <div class='palette-control'>
              <label>Palette <select id='bivariatePaletteSelect'></select></label>
            </div>
            <label for='applyAutoStyleBtn'>
              Sets Layer A and B color thresholds to the histogram's min and max percentile values.
            </label>
            <button class='btn small' id='applyAutoStyleBtn'>Apply Percentile Range</button>
          </div>

          <div class='controls-bar'>
            <div class='control-group tools' data-mode='window'>
              <div class='tool-toggle' role='radiogroup' aria-label='Sampling mode'>
                <button type='button' class='mode-btn is-selected' data-mode='window' aria-pressed='true'>Window</button>
                <button type='button' class='mode-btn' data-mode='shapefile' aria-pressed='false'>Shapefile</button>
              </div>

              <div class='tool-section' data-section='window'>
                <label class='tool-label'>Histogram Sampling Box</label>
                <p class='tool-description'>A square window of this size (in kilometers) follows your mouse to compute scatterplot statistics.</p>
                <div class='window-size'>
                  <label for='windowSlider'>Size (km)</label>
                  <input id='windowSlider' type='range' min=1 max=100 value=50 />
                  <input id='windowSizeNumber' class='num' type='number' />
                </div>
              </div>

              <div class='tool-section' data-section='shapefile'>
                <label class='tool-label' for='shpInput'>Upload Area of Interest (.zip shapefile)</label>
                <p class='tool-description'>If uploaded, the shapefile defines the area for histogram and scatterplot stats, overriding the moving window.</p>
                <input id='shpInput' type='file' accept='.zip' />
              </div>

              <div class='tool-section' data-section='export'>
                <p class='tool-description'>Download the raster layer(s) clipped to the current window or uploaded area.</p>
                <div class='export-actions'>
                  <button type='button' id='exportAreaBtn' class='btn solid export-btn disabled' aria-label='Download Sampling Area'>Download disabled: select area on map</button>
                  <span id='exportStatus' class='small-mono muted' aria-live='polite'></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class='collapse-footer'>
        <button id='headerToggle' class='btn small collapse-toggle' aria-expanded='true' aria-controls='topbarContent'>
        </button>
      </div>
    </header>

    <main>
      <section id='map'>
        <div id='statsOverlay' class='overlay hidden'>
          <div class='overlay-header'>
            <span>Area sampler</span>
            <button id='overlayClose' title='Close'>&times;</button>
          </div>
          <div id='overlayBody' class='overlay-body'></div>
        </div>
      </section>
    </main>

    <script type='module' src='{{ main_js }}'></script>
  </body>
</html>
